FROM golang:1.16-alpine as builder

ENV CGO_ENABLED=0

COPY . /app
WORKDIR /app
RUN CGO_ENABLED=0 go build -o gitlabci-composer-update-mr -ldflags "-s -w" . && \
apk add --no-cache upx && upx -9 gitlabci-composer-update-mr

FROM php:5.6-alpine

WORKDIR /app

RUN apk add --no-cache git bash \
&& wget https://getcomposer.org/download/latest-1.x/composer.phar -O /usr/local/bin/composer-1 && chmod +x /usr/local/bin/composer-1 \
&& wget https://getcomposer.org/download/latest-stable/composer.phar -O /usr/local/bin/composer-2 && chmod +x /usr/local/bin/composer-2

COPY --from=builder /app/gitlabci-composer-update-mr /usr/local/bin/gitlabci-composer-update-mr

ENV COMPOSER_HOME="/tmp/"
